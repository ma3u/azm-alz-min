# Azure Container Registry with Vulnerability Scanning Guide

## Overview

This guide explains the Azure Container Registry (ACR) implementation with comprehensive vulnerability scanning capabilities integrated into your Azure Landing Zone.

## Features Implemented

### üîê Security Features

- **Premium SKU**: Required for vulnerability scanning and private endpoints
- **Admin User Disabled**: Uses managed identities for authentication
- **Network Access**: Private endpoints only (public access denied)
- **Microsoft Defender for Containers**: Integrated vulnerability scanning
- **Soft Delete Policy**: 30-day retention for accidental deletion protection
- **Private DNS Zone**: `privatelink.azurecr.io` for secure name resolution

### üèóÔ∏è Network Architecture

- **Hub Deployment**: ACR deployed in the hub subscription for centralized access
- **Private Subnet**: Dedicated subnet `10.0.4.0/24` for ACR private endpoints
- **VNet Integration**: Connected to both hub and spoke networks via private DNS
- **Zero Trust**: All traffic flows through private endpoints

### üìä Monitoring & Diagnostics

- **Log Analytics Integration**: All ACR logs sent to centralized workspace
- **Diagnostic Categories**: Container registry events, authentication, repository events
- **Metrics**: All performance and usage metrics captured

## Deployment Details

### AVM Module Used

```bicep
module azureContainerRegistry 'br/public:avm/res/container-registry/registry:0.9.3'
```

### Key Parameters

```bicep
acrSku: 'Premium'                    // Required for vulnerability scanning
acrAdminUserEnabled: false           // Security best practice
networkRuleSetDefaultAction: 'Deny'  // Zero trust networking
softDeletePolicyStatus: 'enabled'    // Data protection
```

### Private Endpoint Configuration

```bicep
privateEndpoints: [
  {
    subnetResourceId: '${hubVirtualNetwork.outputs.resourceId}/subnets/snet-acr-private-endpoints'
    privateDnsZoneGroup: {
      privateDnsZoneGroupConfigs: [
        {
          name: 'acr-private-dns-zone-config'
          privateDnsZoneResourceId: privateDnsZoneAcr.outputs.resourceId
        }
      ]
    }
    service: 'registry'
  }
]
```

## Vulnerability Scanning Details

### Microsoft Defender for Containers

The ACR deployment includes Microsoft Defender for Containers integration, which provides:

1. **Image Vulnerability Assessment**

   - Scans container images for known vulnerabilities (CVEs)
   - Provides vulnerability reports with severity levels
   - Continuous monitoring of images in the registry

2. **Security Recommendations**

   - Actionable recommendations to remediate vulnerabilities
   - Integration with Azure Security Center
   - Compliance tracking against security benchmarks

3. **Runtime Protection** (when deployed to AKS)
   - Runtime threat detection for containers
   - Behavioral analysis of container workloads
   - Alert generation for suspicious activities

### Scanning Process

1. **Image Push**: When images are pushed to ACR, automatic scanning begins
2. **Vulnerability Database**: Scans against the latest CVE database
3. **Report Generation**: Detailed vulnerability reports available in Azure portal
4. **Alerts**: High-severity vulnerabilities generate security alerts
5. **Remediation Guidance**: Specific steps provided to fix vulnerabilities

## Using the Container Registry

### Authentication Methods

#### 1. Managed Identity (Recommended)

```bash
# Login using managed identity
az acr login --name <acr-name> --identity
```

#### 2. Azure CLI (Development)

```bash
# Login using Azure CLI credentials
az acr login --name <acr-name>
```

### Container Operations

#### Push Images

```bash
# Tag image for ACR
docker tag myapp:latest <acr-name>.azurecr.io/myapp:latest

# Push to ACR
docker push <acr-name>.azurecr.io/myapp:latest
```

#### Pull Images

```bash
# Pull from ACR
docker pull <acr-name>.azurecr.io/myapp:latest
```

#### View Vulnerability Scan Results

```bash
# List repositories and their vulnerability status
az acr repository list --name <acr-name>

# Get vulnerability report for specific image
az security assessment list \
  --scope "/subscriptions/<subscription-id>/resourceGroups/<rg-name>/providers/Microsoft.ContainerRegistry/registries/<acr-name>/repositories/<repo-name>" \
  --query "[?displayName=='Container registry vulnerability assessment should be enabled'].{Name:displayName, Status:status.code}"
```

## Security Best Practices

### 1. Image Scanning Workflow

```bash
# Scan image before deployment
az acr task create \
  --registry <acr-name> \
  --name scan-task \
  --image myapp:{{.Run.ID}} \
  --context /dev/null \
  --file - <<EOF
FROM <acr-name>.azurecr.io/myapp:latest
RUN echo "Vulnerability scan completed"
EOF
```

### 2. Content Trust (Image Signing)

```bash
# Enable content trust for image signing
export DOCKER_CONTENT_TRUST=1
docker push <acr-name>.azurecr.io/myapp:signed
```

### 3. Quarantine Policy

Images with high-severity vulnerabilities are automatically quarantined and cannot be pulled until remediated.

### 4. Network Security

- All access through private endpoints only
- No public internet access to registry
- Network traffic encrypted in transit

## Monitoring & Alerting

### Key Metrics to Monitor

1. **Image Pull/Push Operations**: Track registry usage
2. **Authentication Failures**: Monitor security incidents
3. **Vulnerability Scan Results**: Track security posture
4. **Storage Usage**: Monitor costs and capacity

### Setting up Alerts

```bash
# Create alert for high-severity vulnerabilities
az monitor metrics alert create \
  --name "ACR-HighSeverityVulnerabilities" \
  --resource-group <rg-name> \
  --resource <acr-name> \
  --resource-type "Microsoft.ContainerRegistry/registries" \
  --metric "VulnerabilityScanFailures" \
  --operator GreaterThan \
  --threshold 0 \
  --severity 2
```

## Compliance & Governance

### Regulatory Alignment

- **NIST Cybersecurity Framework**: Vulnerability management (DE.CM-8)
- **CIS Controls**: Secure configuration of enterprise assets
- **ISO 27001**: Information security controls for container security
- **SOC 2**: Security monitoring and vulnerability management

### Policy Integration

The ACR deployment supports Azure Policy integration for:

- Requiring vulnerability scanning on all images
- Enforcing private endpoint usage
- Mandating soft delete policies
- Ensuring proper tagging and governance

## Troubleshooting

### Common Issues

#### 1. Private Endpoint DNS Resolution

```bash
# Test DNS resolution
nslookup <acr-name>.azurecr.io

# Should resolve to private IP (10.0.4.x range)
```

#### 2. Authentication Issues

```bash
# Check ACR permissions
az acr show --name <acr-name> --query "adminUserEnabled"

# Verify managed identity access
az role assignment list --scope <acr-resource-id>
```

#### 3. Vulnerability Scan Not Running

```bash
# Check Microsoft Defender for Containers status
az security pricing show --name "Containers"

# Verify assessment results
az security assessment list --scope <acr-resource-id>
```

## Cost Optimization

### ACR Premium Pricing

- **Base Cost**: ~$500/month for Premium tier
- **Storage**: Additional costs for image storage
- **Geo-replication**: Additional costs if enabled
- **Bandwidth**: Egress costs for image pulls

### Cost Reduction Strategies

1. **Image Cleanup**: Regular cleanup of unused images
2. **Lifecycle Policies**: Automatic deletion of old images
3. **Compression**: Use multi-stage builds and alpine images
4. **Monitoring**: Track usage patterns and optimize

## Next Steps

1. **Deploy Container Workloads**: Use AKS or Container Apps to deploy applications
2. **Implement CI/CD**: Integrate with Azure DevOps or GitHub Actions
3. **Advanced Security**: Configure additional security policies
4. **Monitoring**: Set up comprehensive alerting and dashboards
5. **Backup**: Consider geo-replication for disaster recovery

## Resources

- [Azure Container Registry Documentation](https://docs.microsoft.com/en-us/azure/container-registry/)
- [Microsoft Defender for Containers](https://docs.microsoft.com/en-us/azure/defender-for-cloud/defender-for-containers-introduction)
- [AVM Container Registry Module](https://github.com/Azure/bicep-registry-modules/tree/main/avm/res/container-registry/registry)
- [Container Security Best Practices](https://docs.microsoft.com/en-us/azure/container-registry/container-registry-best-practices)
